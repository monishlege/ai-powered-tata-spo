<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tata Steel Anti-Pilferage Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        #map { height: 450px; width: 100%; border-radius: 0.5rem; }
        [v-cloak] { display: none; }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .vehicle-icon-wrapper { background: transparent; border: none; }
        .vehicle-icon { display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: rgba(37,99,235,0.15); color: #1e3a8a; box-shadow: 0 0 0 2px rgba(37,99,235,0.25); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">
    <div id="app" v-cloak class="min-h-screen flex flex-col">
        
        <!-- Top Navigation / Summary Bar -->
        <header class="bg-blue-900 text-white shadow-lg z-10">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="ph ph-truck text-3xl"></i>
                    <div>
                        <h1 class="text-xl font-bold leading-tight">Rebar Transit Anti-Pilferage Console</h1>
                        <p class="text-xs text-blue-200">AI-Led Anti-Pilferage System</p>
                        <p class="text-[10px] text-blue-300 mt-0.5">Real-time AI console to detect rebar pilferage using GPS, load cells, and vision, mapped to Tata Steel SOPs.</p>
                    </div>
                </div>

                <!-- Fleet Summary -->
                <div class="hidden md:flex space-x-6 text-sm">
                    <div class="flex flex-col items-center">
                        <span class="text-blue-300 text-xs uppercase tracking-wider">Active</span>
                        <span class="font-bold text-lg">{{ fleetSummary.active_vehicles }}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-blue-300 text-xs uppercase tracking-wider">Under Alert</span>
                        <span class="font-bold text-lg" :class="fleetSummary.under_alert > 0 ? 'text-red-400 blink' : 'text-green-400'">
                            {{ fleetSummary.under_alert }}
                        </span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-blue-300 text-xs uppercase tracking-wider">System Status</span>
                        <span class="font-bold text-green-400 flex items-center">
                            <span class="w-2 h-2 rounded-full bg-green-400 mr-1"></span> Online
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Business Impact Strip (Simulated) -->
        <div class="bg-white border-b border-slate-200 shadow-sm">
            <div class="container mx-auto px-4 py-2 flex justify-between items-center text-xs">
                <div class="flex space-x-6 text-slate-600">
                    <span class="font-bold text-blue-900 uppercase tracking-wide flex items-center">
                        Business Impact 
                        <span class="ml-2 bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded text-[10px] font-normal normal-case">Simulated</span>
                    </span>
                    <span class="flex items-center"><i class="ph ph-trend-down text-green-600 mr-1"></i> Pilferage Risk: <strong class="ml-1 text-slate-800">-65% vs baseline</strong></span>
                    <span class="flex items-center"><i class="ph ph-lightning text-orange-600 mr-1"></i> Avg Detection: <strong class="ml-1 text-slate-800">< 5 mins</strong></span>
                    <span class="flex items-center"><i class="ph ph-check-circle text-blue-600 mr-1"></i> Trips Monitored: <strong class="ml-1 text-slate-800">{{ formatDate(lastUpdate) }}</strong></span>
                </div>
            </div>
            <div class="container mx-auto px-4 pb-2 text-xs">
                <ul class="list-disc pl-4 text-slate-700 grid grid-cols-1 md:grid-cols-3 gap-x-6">
                    <li>Detects pilferage within 5 minutes of event.</li>
                    <li>Correlates GPS, weight, and CCTV in one view.</li>
                    <li>Encodes Tata Steel SOPs as machine-readable rules.</li>
                </ul>
            </div>
        </div>

        <!-- Chain of Custody Modal -->
        <div v-if="showCustodyModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md border border-slate-200">
                <div class="px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                    <div class="font-semibold text-sm text-slate-700">Digital Chain of Custody</div>
                    <button class="text-slate-500 text-xs px-2 py-0.5 bg-slate-100 rounded" @click="showCustodyModal=false">Close</button>
                </div>
                <div class="p-4 text-xs space-y-3">
                    <div>
                        <div class="text-slate-600 mb-2">Whitelisted Stop: <span class="font-bold">{{ custodyForm.stopName }}</span></div>
                        <label class="block text-slate-500 mb-1">Upload Photo</label>
                        <input type="file" accept="image/*" @change="handleCustodyFile" />
                    </div>
                    <div>
                        <label class="block text-slate-500 mb-1">Driver Signature (type name)</label>
                        <input v-model="custodyForm.signature" class="w-full border rounded px-2 py-1" placeholder="Driver name as signature" />
                    </div>
                    <div>
                        <label class="block text-slate-500 mb-1">Notes</label>
                        <input v-model="custodyForm.notes" class="w-full border rounded px-2 py-1" placeholder="Any remarks" />
                    </div>
                </div>
                <div class="px-4 py-3 border-t border-slate-200 flex justify-end">
                    <button class="px-3 py-1 bg-green-600 text-white rounded" @click="submitCustody">Submit</button>
                </div>
            </div>
        </div>

        <!-- Architecture / Data Flow Strip -->
        <div class="bg-slate-50 border-b border-slate-200">
            <div class="container mx-auto px-4 py-3">
                <div class="flex items-center justify-between text-xs text-slate-700">
                    <div class="flex items-center space-x-2">
                        <div class="px-2 py-1 bg-blue-100 text-blue-700 rounded flex items-center space-x-1">
                            <i class="ph ph-truck"></i><span>Truck</span>
                        </div>
                        <i class="ph ph-caret-right text-slate-400"></i>
                        <div class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded flex items-center space-x-1">
                            <i class="ph ph-device-mobile"></i><span>Sensors (GPS, load cell, CCTV)</span>
                        </div>
                        <i class="ph ph-caret-right text-slate-400"></i>
                        <div class="px-2 py-1 bg-cyan-100 text-cyan-700 rounded flex items-center space-x-1">
                            <i class="ph ph-cloud"></i><span>Edge / Cloud</span>
                        </div>
                        <i class="ph ph-caret-right text-slate-400"></i>
                        <div class="px-2 py-1 bg-purple-100 text-purple-700 rounded flex items-center space-x-1">
                            <i class="ph ph-robot"></i><span>AI Agents</span>
                        </div>
                        <i class="ph ph-caret-right text-slate-400"></i>
                        <div class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded flex items-center space-x-1">
                            <i class="ph ph-chalkboard-teacher"></i><span>Control Room Dashboard</span>
                        </div>
                    </div>
                </div>
                <div class="mt-2 grid grid-cols-5 gap-2 text-[10px] text-slate-600">
                    <div>Telematics stream; route coordination</div>
                    <div>Live location, axle loads, CCTV snapshots</div>
                    <div>Secure ingestion; rule engine</div>
                    <div>Weight Guard, Route Monitor, Stop Analyzer</div>
                    <div>Unified view; SOP enforcement & resolution</div>
                </div>
            </div>
        </div>

        <main class="flex-grow container mx-auto p-4 grid grid-cols-12 gap-6">
            
            <!-- Sidebar: Vehicle List & Data Sources -->
            <div class="col-span-12 md:col-span-3 space-y-6">
                
                <!-- Add Vehicle & Trip -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-100 px-4 py-3 border-b border-slate-200 font-semibold text-sm text-slate-600 flex justify-between items-center">
                        <span class="uppercase">Add Vehicle & Trip</span>
                        <i class="ph ph-plus-circle"></i>
                    </div>
                    <div class="p-4 text-xs space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-slate-500 mb-1">Vehicle Number</label>
                                <input v-model="newTrip.truck_id" class="w-full border rounded px-2 py-1" placeholder="KA-04-AB-1234" />
                            </div>
                            <div>
                                <label class="block text-slate-500 mb-1">Weight (kg)</label>
                                <input v-model.number="newTrip.weight" type="number" class="w-full border rounded px-2 py-1" placeholder="25000" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-slate-500 mb-1">Start Point</label>
                                <select v-model="newTrip.startPreset" class="w-full border rounded px-2 py-1">
                                    <option disabled value="">Choose</option>
                                    <option v-for="p in presets" :key="p.name" :value="p.name">{{ p.name }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-slate-500 mb-1">End Point</label>
                                <select v-model="newTrip.endPreset" class="w-full border rounded px-2 py-1">
                                    <option disabled value="">Choose</option>
                                    <option v-for="p in presets" :key="'end-'+p.name" :value="p.name">{{ p.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-slate-500 mb-1">Driver Name</label>
                                <input v-model="newTrip.driver_name" class="w-full border rounded px-2 py-1" placeholder="Driver Name" />
                            </div>
                            <div>
                                <label class="block text-slate-500 mb-1">Driver Phone</label>
                                <input v-model="newTrip.phone" class="w-full border rounded px-2 py-1" placeholder="+91-9XXXX-XXXXX" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-slate-500 mb-1">Vehicle Ownership</label>
                                <select v-model="newTrip.company" class="w-full border rounded px-2 py-1">
                                    <option value="Tata Steel">Tata Steel</option>
                                    <option value="Third Party Travels">Third Party Travels</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-slate-500 mb-1">Whitelisted Stop</label>
                                <select v-model="newTrip.whitelistPreset" class="w-full border rounded px-2 py-1">
                                    <option value="">None</option>
                                    <option v-for="p in whitelistOptions" :key="p.name" :value="p.name">{{ p.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button @click="registerTripFromForm" class="px-3 py-1 bg-blue-600 text-white rounded">Add & Start</button>
                        </div>
                    </div>
                </div>
                
                <!-- Vehicle Selector -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-100 px-4 py-3 border-b border-slate-200 font-semibold text-sm text-slate-600 flex justify-between items-center">
                        <span class="uppercase">Fleet Overview</span>
                        <i class="ph ph-list"></i>
                    </div>
                    <div class="p-2">
                         <div v-if="trucks.length === 0" class="text-sm text-gray-500 p-4 text-center">
                            No active trips. Run simulation.
                        </div>
                        <div v-for="truck in trucks" :key="truck" 
                             @click="selectTruck(truck)"
                             class="flex items-center justify-between p-3 rounded cursor-pointer hover:bg-blue-50 transition-colors"
                             :class="selectedTruck === truck ? 'bg-blue-50 ring-1 ring-blue-500' : ''">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-200 text-slate-600">
                                    <i class="ph ph-truck"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-sm">{{ truck }}</div>
                                    <!-- Status Chips -->
                                    <div v-if="truck === 'KA-02-XY-5678' || (truck === selectedTruck && alerts.length > 0)" class="mt-1">
                                         <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700">
                                            <span class="w-1.5 h-1.5 rounded-full bg-red-500 mr-1 blink"></span> Under Alert
                                         </span>
                                    </div>
                                    <div v-else class="mt-1">
                                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1"></span> En Route
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <i class="ph ph-caret-right text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Data Sources Card -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div class="bg-slate-100 px-4 py-3 border-b border-slate-200 font-semibold text-sm text-slate-600 uppercase">
                        Data Integration Status
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="flex items-center"><i class="ph ph-globe-hemisphere-west mr-2 text-blue-500"></i> GPS / Telematics</span>
                            <span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">ONLINE</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="flex items-center"><i class="ph ph-scales mr-2 text-blue-500"></i> Load Cells</span>
                            <span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">ONLINE</span>
                        </div>
                         <div class="flex justify-between items-center text-sm">
                            <span class="flex items-center"><i class="ph ph-camera mr-2 text-gray-400"></i> CCTV / Vision</span>
                            <span class="px-2 py-0.5 rounded text-xs font-bold bg-yellow-100 text-yellow-700">STANDBY</span>
                        </div>
                    </div>
                </div>

                 <!-- AI Agents Status -->
                 <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div class="bg-slate-100 px-4 py-3 border-b border-slate-200 font-semibold text-sm text-slate-600 uppercase">
                        Active AI Agents
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex items-center space-x-3">
                            <div class="p-1.5 bg-purple-100 rounded text-purple-600"><i class="ph ph-map-trifold"></i></div>
                            <div>
                                <div class="text-xs font-bold">Route Monitor</div>
                                <div class="text-[10px] text-gray-500">Geofence & Deviation Check</div>
                            </div>
                        </div>
                         <div class="flex items-center space-x-3">
                            <div class="p-1.5 bg-indigo-100 rounded text-indigo-600"><i class="ph ph-scales"></i></div>
                            <div>
                                <div class="text-xs font-bold">Weight Guard</div>
                                <div class="text-[10px] text-gray-500">Real-time Load Integrity</div>
                            </div>
                        </div>
                         <div class="flex items-center space-x-3">
                            <div class="p-1.5 bg-orange-100 rounded text-orange-600"><i class="ph ph-clock-countdown"></i></div>
                            <div>
                                <div class="text-xs font-bold">Stop Analyzer</div>
                                <div class="text-[10px] text-gray-500">Unauthorized Duration Check</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SOP & Geofence Config -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div class="bg-slate-100 px-4 py-3 border-b border-slate-200 font-semibold text-sm text-slate-600 uppercase">
                        SOP & Geofence Configuration
                    </div>
                    <div class="p-4 space-y-3 text-xs">
                        <!-- Audit Log -->
                        <div class="mb-3 pb-2 border-b border-slate-100">
                            <div class="flex items-center text-gray-500 mb-1">
                                <i class="ph ph-clock-counter-clockwise mr-1"></i>
                                <span class="font-bold text-[10px] uppercase">Last Update</span>
                            </div>
                            <div class="text-slate-700">{{ formatDateTime(lastUpdate) }} by <span class="font-bold">Control Room Supervisor</span> (ID TS-OPS-23)</div>
                        </div>

                        <!-- Manual Override -->
                        <div class="mb-3 pb-2 border-b border-slate-100 bg-yellow-50 -mx-4 px-4 py-2 border-l-4 border-l-yellow-400">
                             <div class="flex items-center text-yellow-700 mb-1">
                                <i class="ph ph-toggle-left mr-1"></i>
                                <span class="font-bold text-[10px] uppercase">Manual Override Active</span>
                            </div>
                            <div class="text-slate-700 italic">Allow stop > 20 min near Kharagpur checkpoint (Valid till 2:00 AM).</div>
                        </div>

                        <div>
                            <div class="font-bold text-slate-700 mb-1">Active Geofences</div>
                            <ul class="list-disc text-gray-500 space-y-0.5 pl-4">
                                <li>Jamshedpur Plant (Radius: 2km)</li>
                                <li>Kolkata Hub (Radius: 5km)</li>
                            </ul>
                        </div>
                        <div class="pt-2 border-t border-slate-100">
                            <div class="flex items-center justify-between mb-1">
                                <div class="font-bold text-slate-700">Active SOP Rules</div>
                                <button class="flex items-center text-[10px] px-2 py-0.5 bg-slate-100 rounded border border-slate-200 text-slate-600" @click="openSopConfig">
                                    <i class="ph ph-pencil mr-1"></i> Edit
                                </button>
                            </div>
                            <ul class="space-y-1 text-gray-500">
                                <li><span class="font-semibold text-slate-700">SOP-089 (Stop):</span> Stop > {{ sop089Minutes }} min outside approved zone → Alert.</li>
                                <li><span class="font-semibold text-slate-700">SOP-102 (Weight):</span> Drop > {{ sop102DropPercent }}% outside hub → Lockout.</li>
                                <li><span class="font-semibold text-slate-700">SOP-075 (Route):</span> Deviation > {{ sop075DeviationKm }} km from corridor → Control room notification.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Demo Narrative Flow -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div class="bg-slate-100 px-4 py-3 border-b border-slate-200 font-semibold text-sm text-slate-600 uppercase">
                        Live Demo Story
                    </div>
                    <div class="p-4">
                        <ol class="relative border-l border-slate-200 ml-2">                  
                            <li class="mb-4 ml-4">
                                <div class="absolute w-3 h-3 bg-slate-200 rounded-full mt-1.5 -left-1.5 border border-white"></div>
                                <h3 class="text-xs font-semibold text-slate-900">1. Departure</h3>
                                <p class="mb-1 text-[10px] font-normal text-gray-500">Truck leaves Jamshedpur Plant with full load inside geofence.</p>
                            </li>
                            <li class="mb-4 ml-4">
                                <div class="absolute w-3 h-3 bg-slate-200 rounded-full mt-1.5 -left-1.5 border border-white"></div>
                                <h3 class="text-xs font-semibold text-slate-900">2. Route Deviation</h3>
                                <p class="text-[10px] font-normal text-gray-500">Route Monitor detects 7 km deviation near Kharagpur → SOP-075.</p>
                            </li>
                             <li class="mb-4 ml-4">
                                <div class="absolute w-3 h-3 bg-slate-200 rounded-full mt-1.5 -left-1.5 border border-white"></div>
                                <h3 class="text-xs font-semibold text-slate-900">3. Suspicious Stop</h3>
                                <p class="text-[10px] font-normal text-gray-500">Stop Analyzer flags 18 min non-whitelisted stop → SOP-089.</p>
                            </li>
                            <li class="mb-4 ml-4">
                                <div class="absolute w-3 h-3 bg-slate-200 rounded-full mt-1.5 -left-1.5 border border-white"></div>
                                <h3 class="text-xs font-semibold text-slate-900">4. Theft Event</h3>
                                <p class="text-[10px] font-normal text-gray-500">Weight Guard detects 200kg drop. Alert escalated to CRITICAL.</p>
                            </li>
                             <li class="mb-4 ml-4">
                                <div class="absolute w-3 h-3 bg-green-500 rounded-full mt-1.5 -left-1.5 border border-white"></div>
                                <h3 class="text-xs font-semibold text-slate-900">5. Resolution</h3>
                                <p class="text-[10px] font-normal text-gray-500">Control Room verifies via CCTV/Reweigh. Pilferage prevented.</p>
                            </li>
                        </ol>
                    </div>
                </div>

            </div>

            <!-- Main Content: Map & Dashboard -->
            <div class="col-span-12 md:col-span-9 space-y-6">
                
                <!-- Vehicle Stats Row -->
                <div v-if="currentStatus" class="grid grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="text-xs text-gray-500 uppercase">Current Speed</div>
                        <div class="text-2xl font-bold text-slate-800">{{ safeSpeed(currentTelemetry) }} <span class="text-sm font-normal text-gray-400">km/h</span></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="text-xs text-gray-500 uppercase">Live Weight</div>
                        <div class="text-2xl font-bold text-slate-800">{{ safeWeight(currentTelemetry) }} <span class="text-sm font-normal text-gray-400">kg</span></div>
                    </div>
                     <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="text-xs text-gray-500 uppercase">Trip Status</div>
                        <div class="text-lg font-bold" :class="currentStatus.is_stopped ? 'text-orange-500' : 'text-green-500'">
                            {{ currentStatus.is_stopped ? 'STOPPED' : 'IN TRANSIT' }}
                        </div>
                    </div>
                     <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                        <div class="text-xs text-gray-500 uppercase">Last Update</div>
                        <div class="text-sm font-mono mt-1">{{ safeTimestamp(currentTelemetry) }}</div>
                    </div>
                </div>

                <!-- Analytics Snapshot -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 flex items-center">
                            <i class="ph ph-chart-bar text-emerald-600 mr-2 text-xl"></i>
                            Analytics Snapshot
                        </h2>
                        <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">Simulated</span>
                    </div>
                    <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
                        <div>
                            <div class="font-semibold text-slate-600 mb-1">Top 5 Risky Routes</div>
                            <ul class="list-disc pl-4 text-slate-700 space-y-0.5">
                                <li>Jamshedpur → Kolkata (Eastern Corridor)</li>
                                <li>Kharagpur → Kolaghat</li>
                                <li>Kolaghat → Kolkata Hub</li>
                                <li>Jamshedpur → Kharagpur</li>
                                <li>Mid Corridor Variants</li>
                            </ul>
                        </div>
                        <div>
                            <div class="font-semibold text-slate-600 mb-1">Avg Detection Time</div>
                            <div class="text-slate-700">Critical events detected within ~5 minutes.</div>
                        </div>
                        <div>
                            <div class="font-semibold text-slate-600 mb-1">Pilferage Risk Heatmap</div>
                            <div class="text-slate-700">Most alerts concentrated in Eastern Corridor near Kolaghat.</div>
                        </div>
                    </div>
                </div>

                <!-- Map -->
                <div class="bg-white p-1 rounded-lg shadow-sm border border-slate-200">
                    <div id="map"></div>
                </div>

                <!-- Intelligence Log (SOP Driven) -->
                <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 flex items-center">
                            <i class="ph ph-brain text-purple-600 mr-2 text-xl"></i>
                            SOP Enforcement & Intelligence Log
                        </h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">Real-time Feed</span>
                            <button class="text-xs px-2 py-1 bg-purple-600 text-white rounded" @click="predictRiskForSelected" :disabled="!selectedTruck">Predict Risk</button>
                            <button class="text-xs px-2 py-1 rounded" :class="edgeOfflineByTruck[selectedTruck] ? 'bg-orange-600 text-white' : 'bg-slate-200 text-slate-700'" @click="toggleEdgeMode" :disabled="!selectedTruck">
                                {{ edgeOfflineByTruck[selectedTruck] ? 'Edge: Offline' : 'Edge: Online' }}
                            </button>
                        </div>
                    </div>
                    <div class="px-6 py-2 text-xs text-slate-700">
                        <div class="font-semibold text-slate-600 mb-1">Simulated Intelligence Entries</div>
                        <ul class="space-y-1">
                            <li v-for="(log, idx) in intelLogEntries" :key="log.id" class="flex justify-between">
                                <span>Log #{{ idx + 1 }} – {{ log.label }}</span>
                                <span class="font-mono">{{ formatTime(log.time) }}</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="divide-y divide-slate-100 max-h-96 overflow-y-auto">
                        <div v-if="alerts.length === 0" class="p-4 text-xs text-slate-700 space-y-2">
                            <div class="flex items-start space-x-2 p-3 rounded border border-slate-200 bg-slate-50">
                                <div class="p-1.5 bg-red-100 text-red-600 rounded"><i class="ph ph-warning-octagon"></i></div>
                                <div class="flex-grow">
                                    <div class="font-bold">CRITICAL – WEIGHT_MISMATCH | SOP-102</div>
                                    <div>200kg drop detected near Kolaghat | Action: Security alerted.</div>
                                </div>
                            </div>
                            <div class="flex items-start space-x-2 p-3 rounded border border-slate-200 bg-slate-50">
                                <div class="p-1.5 bg-orange-100 text-orange-600 rounded"><i class="ph ph-warning"></i></div>
                                <div class="flex-grow">
                                    <div class="font-bold">HIGH – SUSPICIOUS_STOP | SOP-089</div>
                                    <div>18 min stop at non-whitelisted dhaba | Action: Verification call.</div>
                                </div>
                            </div>
                            <div class="flex items-start space-x-2 p-3 rounded border border-slate-200 bg-slate-50">
                                <div class="p-1.5 bg-green-100 text-green-700 rounded"><i class="ph ph-shield-check"></i></div>
                                <div class="flex-grow">
                                    <div class="font-bold">RESOLVED – WEIGHT_MISMATCH | SOP-102</div>
                                    <div>No loss confirmed at Kolkata Hub | Action: Alert closed.</div>
                                </div>
                            </div>
                        </div>

                        <div v-for="alert in reversedAlerts" :key="alert.alert_id" class="p-4 hover:bg-slate-50 transition-colors">
                            <div class="flex items-start space-x-4">
                                <!-- Severity Icon -->
                                <div class="mt-1">
                                    <div v-if="alert.severity === 'CRITICAL'" class="p-2 bg-red-100 text-red-600 rounded-lg"><i class="ph ph-warning-octagon text-xl"></i></div>
                                    <div v-else-if="alert.severity === 'HIGH'" class="p-2 bg-orange-100 text-orange-600 rounded-lg"><i class="ph ph-warning text-xl"></i></div>
                                    <div v-else class="p-2 bg-yellow-100 text-yellow-600 rounded-lg"><i class="ph ph-info text-xl"></i></div>
                                </div>
                                
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start">
                                        <div class="flex items-center">
                                            <span class="text-xs font-bold uppercase tracking-wider" 
                                                :class="{
                                                    'text-red-600': alert.severity === 'CRITICAL',
                                                    'text-orange-600': alert.severity === 'HIGH',
                                                    'text-yellow-600': alert.severity === 'MEDIUM'
                                                }">
                                                {{ alert.type }}
                                            </span>
                                            <!-- Severity Tag -->
                                            <span v-if="alert.severity === 'CRITICAL'" class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700 border border-red-200">CRITICAL</span>
                                            <span v-else-if="alert.severity === 'HIGH'" class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-orange-100 text-orange-700 border border-orange-200">HIGH</span>
                                            <span v-else-if="alert.severity === 'MEDIUM'" class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">MEDIUM</span>

                                            <!-- Status Tag -->
                                            <span v-if="alert.status === 'RESOLVED'" class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200">RESOLVED</span>
                                            <span v-else class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 border border-blue-100">UNRESOLVED</span>

                                            <span class="text-xs text-gray-400 ml-2">via {{ alert.agent_name }}</span>
                                        </div>
                                        <span class="text-xs text-gray-400 font-mono">{{ formatTime(alert.timestamp) }}</span>
                                    </div>
                                    
                                    <h3 class="font-bold text-slate-800 text-sm mt-1">{{ displayDescription(alert) }}</h3>
                                    
                                    <!-- Rich Metadata Box -->
                                    <div class="mt-3 bg-slate-50 rounded border border-slate-200 p-3 grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                                        <div v-if="alert.why_flagged">
                                            <span class="font-semibold text-slate-500 block mb-1">Why Flagged?</span>
                                            <span class="text-slate-700">{{ alert.why_flagged }}</span>
                                        </div>
                                         <div v-if="alert.sop_rule">
                                            <span class="font-semibold text-slate-500 block mb-1">SOP Rule Triggered</span>
                                            <span class="text-slate-700">{{ alert.sop_rule }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Taken -->
                                    <div v-if="alert.action_taken" class="mt-2 flex items-center text-xs font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded w-max">
                                        <i class="ph ph-lightning mr-1"></i> ACTION: {{ alert.action_taken }}
                                    </div>

                                    <!-- SOP-Specific Actions -->
                                    <div class="mt-3 flex items-center space-x-2">
                                        <span v-if="alert.sop_rule && alert.sop_rule.includes('SOP-102')" class="px-2 py-1 text-[10px] bg-red-100 text-red-700 rounded border border-red-200">Security Alert</span>
                                        <span v-if="alert.sop_rule && alert.sop_rule.includes('SOP-075')" class="px-2 py-1 text-[10px] bg-indigo-100 text-indigo-700 rounded border border-indigo-200">Control Room Notification</span>
                                    </div>
                                    <div class="mt-2 flex items-center space-x-2">
                                        <button 
                                            class="px-2 py-1 text-xs rounded bg-blue-600 text-white disabled:bg-slate-300 disabled:text-slate-600"
                                            :disabled="alert.sop_rule && alert.sop_rule.includes('SOP-089') && minutesSince(alert.timestamp) < 15"
                                            @click="contactDriver(alert)"
                                        >
                                            Contact Driver
                                        </button>
                                        <button 
                                            v-if="alert._contactVisible"
                                            class="px-2 py-1 text-xs rounded bg-slate-600 text-white"
                                            @click="hideContact(alert.alert_id)"
                                        >
                                            Hide Contact
                                        </button>
                                        <button 
                                            class="px-2 py-1 text-xs rounded bg-green-600 text-white"
                                            @click="resolveAlert(alert.alert_id)"
                                        >
                                            Resolve
                                        </button>
                                        <button 
                                            v-if="alert.status === 'RESOLVED'"
                                            class="px-2 py-1 text-xs rounded bg-red-600 text-white"
                                            @click="unresolveAlert(alert.alert_id)"
                                        >
                                            Unresolve
                                        </button>
                                        <span v-if="alert.sop_rule && alert.sop_rule.includes('SOP-089') && minutesSince(alert.timestamp) < 15" class="text-[10px] text-slate-500">Contact available after 15 min</span>
                                    </div>

                                    <!-- Driver Details -->
                                    <div v-if="alert._contactVisible || (alert.sop_rule && alert.sop_rule.includes('SOP-089') && minutesSince(alert.timestamp) >= 15)" class="mt-3 bg-slate-50 rounded border border-slate-200 p-3 text-xs">
                                        <div class="font-semibold text-slate-600 mb-1">Driver Contact</div>
                                        <div class="text-slate-700" v-if="alert._contact">
                                            <div>Driver: {{ alert._contact.driver_name }}</div>
                                            <div>Phone: {{ alert._contact.phone }}</div>
                                            <div>Travels: {{ alert._contact.company }}</div>
                                        </div>
                                        <div v-else class="text-slate-500">Fetching contact details...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
        <!-- Resolve Feedback Popup (In-App) -->
        <div v-if="resolveFeedback && resolveFeedback.visible" class="fixed top-4 right-4 z-50">
            <div :class="resolveFeedback.status === 'success' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'"
                 class="px-3 py-2 rounded border shadow flex items-center space-x-2 text-sm">
                <i :class="resolveFeedback.status === 'success' ? 'ph ph-check-circle' : 'ph ph-warning'"></i>
                <span>{{ resolveFeedback.text }}</span>
                <button class="ml-2 text-xs px-2 py-0.5 bg-slate-100 rounded" @click="closeResolveFeedback">Close</button>
            </div>
        </div>

        <!-- SOP Configurator Modal -->
        <div v-if="sopConfigModalVisible" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md border border-slate-200">
                <div class="px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                    <div class="font-semibold text-sm text-slate-700">SOP Rules Configurator</div>
                    <button class="text-slate-500 text-xs px-2 py-0.5 bg-slate-100 rounded" @click="closeSopConfig">Close</button>
                </div>
                <div class="p-4 text-xs space-y-3">
                    <div>
                        <label class="block text-slate-500 mb-1">SOP-089: Stop outside approved zone (minutes)</label>
                        <input v-model.number="sop089Minutes" type="number" class="w-full border rounded px-2 py-1" min="1" />
                    </div>
                    <div>
                        <label class="block text-slate-500 mb-1">SOP-102: Weight drop outside hub (%)</label>
                        <input v-model.number="sop102DropPercent" type="number" class="w-full border rounded px-2 py-1" min="1" />
                    </div>
                    <div>
                        <label class="block text-slate-500 mb-1">SOP-075: Route deviation (km)</label>
                        <input v-model.number="sop075DeviationKm" type="number" class="w-full border rounded px-2 py-1" min="1" />
                    </div>
                </div>
                <div class="px-4 py-3 border-t border-slate-200 flex justify-end">
                    <button class="px-3 py-1 bg-blue-600 text-white rounded" @click="saveSopConfig">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <footer class="bg-white border-t border-slate-200 mt-auto">
            <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center text-xs text-slate-500">
                <div class="mb-2 md:mb-0">
                    <span class="font-bold">Designed for:</span> AI-Led Prevention of Pilferage in Rebar Transportation – Tata Steel problem statement
                </div>
                <div class="flex items-center space-x-4">
                    <span>Solution by Team Monish R – AI & DevOps</span>
                    <span class="text-slate-400">|</span>
                    <span class="text-slate-500">FastAPI • Vue • Leaflet • Python AI</span>
                    <span>&copy; {{ currentYear }}</span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    newTrip: {
                        truck_id: '',
                        weight: 25000,
                        startPreset: '',
                        endPreset: '',
                        driver_name: '',
                        phone: '',
                        company: 'Tata Steel',
                        whitelistPreset: ''
                    },
                    presets: [
                        { name: 'Tata Steel Jamshedpur Plant', lat: 22.8046, lng: 86.2029 },
                        { name: 'Kolkata Hub', lat: 22.5726, lng: 88.3639 },
                        { name: 'Godown / Store Room', lat: 22.7000, lng: 87.1000 }
                    ],
                    whitelistOptions: [
                        { name: 'Kharagpur Check', lat: 22.3460, lng: 87.2320, radius: 200, max: 30 },
                        { name: 'Kolaghat Check', lat: 22.4327, lng: 87.8672, radius: 200, max: 30 },
                        { name: 'Midway Dhaba', lat: 22.6000, lng: 87.0000, radius: 200, max: 45 }
                    ],
                    telemetryLoops: {},
                    trucks: [],
                    selectedTruck: null,
                    currentStatus: null,
                    currentTelemetry: null,
                    truckStatuses: {},
                    lastTelemetryByTruck: {},
                    alerts: [],
                    fleetSummary: { active_vehicles: 0, under_alert: 0 },
                    map: null,
                    marker: null,
                    markersByTruck: {},
                    polling: null,
                    currentYear: new Date().getFullYear(),
                    lastUpdate: new Date(),
                    vehicleIcon: null,
                    lastMarkerLatLng: null,
                    animating: false,
                    driverInfo: {},
                    tileProviderIndex: 0,
                    currentTileLayer: null,
                    contactState: {},
                    resolveFeedback: { visible: false, text: '', status: 'info' },
                    sop089Minutes: 15,
                    sop102DropPercent: 10,
                    sop075DeviationKm: 5,
                    sopConfigModalVisible: false,
                    intelLogEntries: [],
                    intelLogTimer: null,
                    intelLogCounter: 0,
                    startSimDateParts: null,
                    startSimTimeParts: null,
                    riskInfo: null,
                    edgeOfflineByTruck: {},
                    showCustodyModal: false,
                    custodyForm: { stopName: '', photo_base64: null, signature: '', notes: '' }
                }
            },
            computed: {
                reversedAlerts() {
                    return [...this.alerts].reverse();
                }
            },
            methods: {
                openSopConfig() {
                    this.sopConfigModalVisible = true;
                },
                closeSopConfig() {
                    this.sopConfigModalVisible = false;
                },
                saveSopConfig() {
                    this.sopConfigModalVisible = false;
                    this.resolveFeedback = { visible: true, text: 'SOP updated', status: 'success' };
                },
                safeSpeed(t) {
                    return t && t.speed_kmh != null ? t.speed_kmh.toFixed(1) : '--';
                },
                safeWeight(t) {
                    return t && t.weight_kg != null ? t.weight_kg.toFixed(0) : '--';
                },
                safeTimestamp(t) {
                    return t && t.timestamp ? this.formatTime(t.timestamp) : '--:--:--';
                },
                formatTime(isoString) {
                    if (!isoString) return '--:--:--';
                    return new Date(isoString).toLocaleTimeString();
                },
                formatDate(d) {
                    return new Date(d).toLocaleDateString();
                },
                formatDateTime(d) {
                    return new Date(d).toLocaleString();
                },
                minutesSince(isoString) {
                    const now = new Date();
                    const t = new Date(isoString);
                    return Math.floor((now.getTime() - t.getTime()) / 60000);
                },
                startIntelLog() {
                    const now = new Date();
                    this.startSimDateParts = { y: now.getFullYear(), m: now.getMonth(), d: now.getDate() };
                    this.startSimTimeParts = { h: now.getHours(), m: now.getMinutes(), s: now.getSeconds() };
                    this.intelLogEntries = [];
                    this.intelLogCounter = 0;
                    this.addIntelLog(0);
                    if (this.intelLogTimer) clearInterval(this.intelLogTimer);
                    this.intelLogTimer = setInterval(() => {
                        this.intelLogCounter += 1;
                        this.addIntelLog(this.intelLogCounter);
                    }, 30000);
                },
                addIntelLog(counter) {
                    const base = this.startSimTimeParts;
                    const date = this.startSimDateParts;
                    const hours = (base.h + counter * 3) % 24;
                    const dt = new Date(date.y, date.m, date.d, hours, base.m, base.s);
                    this.intelLogEntries.push({
                        id: `${date.y}-${date.m}-${date.d}-${counter}`,
                        time: dt.toISOString(),
                        label: `Journey progressed +${counter * 3}h`
                    });
                },
                async predictRiskForSelected() {
                    if (!this.selectedTruck) return;
                    try {
                        const res = await axios.get(`/api/v1/risk/${this.selectedTruck}`);
                        this.riskInfo = res.data;
                        this.resolveFeedback = { visible: true, text: this.riskInfo.message, status: this.riskInfo.risk_score >= 0.5 ? 'error' : 'success' };
                    } catch (e) { console.error(e); }
                },
                async toggleEdgeMode() {
                    if (!this.selectedTruck) return;
                    const current = !!this.edgeOfflineByTruck[this.selectedTruck];
                    const next = !current;
                    try {
                        const res = await axios.post(`/api/v1/edge/${this.selectedTruck}/mode?offline=${next}`);
                        this.edgeOfflineByTruck[this.selectedTruck] = res.data.edge_offline;
                        this.resolveFeedback = { visible: true, text: next ? 'Edge set to Offline (buffering telemetry)' : 'Edge Online (processing live)', status: next ? 'error' : 'success' };
                        if (!next) {
                            await axios.post(`/api/v1/edge/${this.selectedTruck}/sync`);
                        }
                    } catch (e) { console.error(e); }
                },
                handleCustodyFile(ev) {
                    const file = ev.target.files && ev.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = () => {
                        this.custodyForm.photo_base64 = reader.result.toString();
                    };
                    reader.readAsDataURL(file);
                },
                async submitCustody() {
                    if (!this.selectedTruck) return;
                    try {
                        const payload = {
                            truck_id: this.selectedTruck,
                            stop_name: this.custodyForm.stopName || 'Whitelisted Stop',
                            photo_base64: this.custodyForm.photo_base64,
                            signature: this.custodyForm.signature,
                            notes: this.custodyForm.notes
                        };
                        await axios.post('/api/v1/custody', payload);
                        this.showCustodyModal = false;
                        this.resolveFeedback = { visible: true, text: 'Custody verified at whitelisted stop', status: 'success' };
                    } catch (e) { console.error(e); }
                },
                displayDescription(alert) {
                    const d = alert && alert.description ? alert.description : '';
                    if (alert && alert.status !== 'RESOLVED') {
                        return d.replace(/^ALERT\s+RESOLVED/i, 'ALERT UNRESOLVED');
                    }
                    return d.replace(/^ALERT\s+UNRESOLVED/i, 'ALERT RESOLVED');
                },
                async fetchSummary() {
                    try {
                        const res = await axios.get('/api/v1/fleet/summary');
                        this.fleetSummary = res.data;
                        this.lastUpdate = new Date();
                    } catch (e) { console.error(e); }
                },
                async registerTripFromForm() {
                    try {
                        const start = this.presets.find(p => p.name === this.newTrip.startPreset);
                        const end = this.presets.find(p => p.name === this.newTrip.endPreset);
                        if (!start || !end || !this.newTrip.truck_id) {
                            this.resolveFeedback = { visible: true, text: 'Unresolved', status: 'error' };
                            return;
                        }

                        // Determine Whitelisted Stop
                        let authStops = [];
                        let whitelistStop = null;
                        if (this.newTrip.whitelistPreset) {
                            whitelistStop = this.whitelistOptions.find(p => p.name === this.newTrip.whitelistPreset);
                            if (whitelistStop) {
                                authStops.push({
                                    location: { latitude: whitelistStop.lat, longitude: whitelistStop.lng },
                                    radius_meters: whitelistStop.radius,
                                    max_duration_minutes: whitelistStop.max,
                                    name: whitelistStop.name
                                });
                            }
                        }

                        const trip = {
                            trip_id: `TRIP-${Math.floor(Math.random()*9000)+1000}`,
                            truck_id: this.newTrip.truck_id,
                            start_location: { latitude: start.lat, longitude: start.lng },
                            destination_location: { latitude: end.lat, longitude: end.lng },
                            authorized_stops: authStops,
                            total_expected_weight_kg: this.newTrip.weight,
                            weight_tolerance_kg: 50.0
                        };
                        await axios.post('/api/v1/trips', trip);
                        await axios.post('/api/v1/driver', {
                            truck_id: this.newTrip.truck_id,
                            driver_name: this.newTrip.driver_name || 'Unknown',
                            phone: this.newTrip.phone || 'N/A',
                            company: this.newTrip.company || 'Tata Steel'
                        });
                        this.trucks = Array.from(new Set([...this.trucks, this.newTrip.truck_id]));
                        
                        // Start Simulation Loop with Waypoints
                        this.startTelemetryLoop(this.newTrip.truck_id, start, end, this.newTrip.weight, whitelistStop);
                        
                        this.resolveFeedback = { visible: true, text: 'Trip Started', status: 'success' };
                    } catch (e) {
                        console.error(e);
                        this.resolveFeedback = { visible: true, text: 'Unresolved', status: 'error' };
                    }
                },
                startTelemetryLoop(truckId, start, end, weight, whitelistStop) {
                    // Path Construction: Start -> [Whitelist] -> Mistake(Unwhitelisted) -> End
                    let path = [{ lat: start.lat, lng: start.lng, type: 'start' }];
                    
                    if (whitelistStop) {
                        path.push({ lat: whitelistStop.lat, lng: whitelistStop.lng, type: 'whitelist', name: whitelistStop.name });
                    }

                    // Calculate Mistake Point (Unwhitelisted Stop)
                    // Place it somewhere between the last point and end, but offset
                    const last = path[path.length - 1];
                    const mistakeLat = (last.lat + end.lat) / 2 + 0.02; // Small offset
                    const mistakeLng = (last.lng + end.lng) / 2 - 0.02;
                    path.push({ lat: mistakeLat, lng: mistakeLng, type: 'mistake' }); // This is the unwhitelisted stop

                    path.push({ lat: end.lat, lng: end.lng, type: 'end' });

                    let currentSegment = 0;
                    let progress = 0;
                    const speedFactor = 0.005; // "Slowly" - smaller increment per tick
                    let isStopped = false;
                    let stopTimer = 0; // Simulated minutes
                    
                    // Initial simulated time
                    let simulatedTime = new Date();

                    const timer = setInterval(async () => {
                        if (currentSegment >= path.length - 1) {
                            clearInterval(timer);
                            delete this.telemetryLoops[truckId];
                            return;
                        }

                        const p1 = path[currentSegment];
                        const p2 = path[currentSegment + 1];

                        // Interpolate
                        const lat = p1.lat + (p2.lat - p1.lat) * progress;
                        const lng = p1.lng + (p2.lng - p1.lng) * progress;

                        // Check if we should stop at the destination of this segment
                        // Logic: If we reach p2, and p2 is 'mistake', stop there.
                        // If p2 is 'whitelist', maybe pause briefly?
                        
                        // Advance time normally
                        simulatedTime = new Date(simulatedTime.getTime() + 1000); 

                        let speed = 45.0;
                        
                        if (isStopped) {
                            speed = 0.0;
                            // Accelerate simulated time during stop to trigger alert faster
                            // 1 real second = 1 simulated minute
                            stopTimer++;
                            simulatedTime = new Date(simulatedTime.getTime() + 60000); 
                            
                            // Check if done stopping
                            if (stopTimer > 20) { // > 15 mins to trigger SOP-089
                                isStopped = false;
                                stopTimer = 0;
                                currentSegment++;
                                progress = 0;
                            }
                        } else {
                            progress += speedFactor;
                            if (progress >= 1) {
                                progress = 1;
                                // We reached p2
                                if (p2.type === 'mistake') {
                                    isStopped = true;
                                    // Don't advance segment yet
                                } else if (p2.type === 'whitelist') {
                                    // Just pass through or brief pause?
                                    // Let's pass through for smoothness or pause briefly
                                    // User said "move to white listed", then "stopped in unwhitelisted"
                                    this.custodyForm.stopName = p2.name || 'Whitelisted Stop';
                                    this.showCustodyModal = true;
                                    currentSegment++;
                                    progress = 0;
                                } else {
                                    currentSegment++;
                                    progress = 0;
                                }
                            }
                        }

                        const telemetry = {
                            truck_id: truckId,
                            timestamp: simulatedTime.toISOString(),
                            location: { latitude: lat, longitude: lng },
                            weight_kg: weight + (Math.random()*4-2),
                            speed_kmh: speed,
                            ignition_on: true
                        };
                        try { await axios.post('/api/v1/telemetry', telemetry); } catch (_) {}
                        
                    }, 1000); // 1 tick per second
                    this.telemetryLoops[truckId] = timer;
                },
                async fetchTrucks() {
                    try {
                        const res = await axios.get('/api/v1/trucks');
                        this.trucks = res.data;
                        if (this.trucks.length > 0 && !this.selectedTruck) {
                            this.selectTruck(this.trucks[0]);
                        }
                    } catch (e) { console.error(e); }
                },
                async fetchAllStatuses() {
                    if (!this.trucks || this.trucks.length === 0) return;
                    try {
                        const requests = this.trucks.map(t => axios.get(`/api/v1/status/${t}`).then(r => ({ id: t, data: r.data })).catch(_ => null));
                        const results = await Promise.all(requests);
                        results.filter(Boolean).forEach(({ id, data }) => {
                            this.truckStatuses[id] = data;
                            const tel = data.last_telemetry;
                            if (tel) {
                                this.lastTelemetryByTruck[id] = tel;
                                this.updateMapForTruck(id, tel);
                                if (this.selectedTruck === id) {
                                    this.currentStatus = data;
                                    this.currentTelemetry = tel;
                                }
                            }
                        });
                    } catch (e) { console.error(e); }
                },
                selectTruck(truckId) {
                    this.selectedTruck = truckId;
                    this.fetchStatus();
                },
                async fetchStatus() {
                    if (!this.selectedTruck) return;
                    try {
                        const [statusRes, alertsRes] = await Promise.all([
                            axios.get(`/api/v1/status/${this.selectedTruck}`),
                            axios.get(`/api/v1/alerts?truck_id=${this.selectedTruck}`)
                        ]);

                        this.currentStatus = statusRes.data;
                        this.currentTelemetry = this.currentStatus.last_telemetry;
                        this.alerts = alertsRes.data;
                        this.applyLocalUiState(this.alerts);

                        this.updateMap();
                    } catch (e) { console.error(e); }
                },
                applyLocalUiState(alerts) {
                    alerts.forEach(a => {
                        const cs = this.contactState[a.alert_id];
                        if (cs) {
                            a._contactVisible = cs.visible;
                            a._contact = cs.data;
                        }
                    });
                },
                async resolveAlert(alertId) {
                    try {
                        const res = await axios.post('/api/v1/alerts/resolve', { alert_id: alertId });
                        const updated = res.data;
                        const idx = this.alerts.findIndex(a => a.alert_id === alertId);
                        if (idx >= 0) this.alerts[idx].status = updated.status;
                        this.applyLocalUiState(this.alerts);
                        this.resolveFeedback = { visible: true, text: 'SOP resolved', status: 'success' };
                        setTimeout(() => { this.resolveFeedback.visible = true; }, 0);
                        setTimeout(() => { this.resolveFeedback.visible = false; }, 3000);
                    } catch (e) { 
                        console.error(e); 
                        this.resolveFeedback = { visible: true, text: 'Unresolved', status: 'error' };
                        setTimeout(() => { this.resolveFeedback.visible = true; }, 0);
                        setTimeout(() => { this.resolveFeedback.visible = false; }, 3000);
                    }
                },
                async unresolveAlert(alertId) {
                    try {
                        const res = await axios.post('/api/v1/alerts/unresolve', { alert_id: alertId });
                        const updated = res.data;
                        const idx = this.alerts.findIndex(a => a.alert_id === alertId);
                        if (idx >= 0) this.alerts[idx].status = updated.status;
                        this.applyLocalUiState(this.alerts);
                        this.resolveFeedback = { visible: true, text: 'Marked Unresolved', status: 'error' };
                        setTimeout(() => { this.resolveFeedback.visible = true; }, 0);
                        setTimeout(() => { this.resolveFeedback.visible = false; }, 3000);
                    } catch (e) {
                        console.error(e);
                        this.resolveFeedback = { visible: true, text: 'Unresolved', status: 'error' };
                        setTimeout(() => { this.resolveFeedback.visible = true; }, 0);
                        setTimeout(() => { this.resolveFeedback.visible = false; }, 3000);
                    }
                },
                async contactDriver(alert) {
                    try {
                        const res = await axios.get(`/api/v1/driver/${alert.truck_id}`);
                        const payload = { visible: true, data: res.data };
                        this.contactState[alert.alert_id] = payload;
                        this.contactState[alert.alert_id] = payload;
                        alert._contact = payload.data;
                        alert._contactVisible = payload.visible;
                    } catch (e) { console.error(e); }
                },
                hideContact(alertId) {
                    const cs = this.contactState[alertId];
                    if (cs) cs.visible = false;
                    const a = this.alerts.find(x => x.alert_id === alertId);
                    if (a) a._contactVisible = false;
                },
                closeResolveFeedback() {
                    this.resolveFeedback.visible = false;
                },
                initMap() {
                    this.map = L.map('map').setView([22.5, 87.3], 9);
                    const transparent = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=';
                    this.currentTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '© CARTO',
                        subdomains: 'abcd',
                        errorTileUrl: transparent
                    }).addTo(this.map);
                    const dhabaIcon = L.divIcon({
                        html: '<div style=\"width:22px;height:22px;border-radius:50%;background:#fde68a;color:#92400e;font-weight:700;display:flex;align-items:center;justify-content:center;border:2px solid #f59e0b;\">D</div>',
                        className: 'vehicle-icon-wrapper',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });
                    L.marker([22.6000, 87.0000], { icon: dhabaIcon }).addTo(this.map).bindTooltip('Midway Dhaba', { direction: 'top' });
                    this.vehicleIcon = L.divIcon({
                        html: '<div class="vehicle-icon"><i class="ph ph-truck"></i></div>',
                        className: 'vehicle-icon-wrapper',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    // Static Landmarks (Jamshedpur -> Kolkata)
                    const landmarks = [
                        { name: "Jamshedpur Plant", lat: 22.8046, lng: 86.2029, type: 'start' },
                        { name: "Kharagpur (Check)", lat: 22.3460, lng: 87.2320, type: 'mid' },
                        { name: "Kolaghat (Check)", lat: 22.4327, lng: 87.8672, type: 'mid' },
                        { name: "Kolkata Hub", lat: 22.5726, lng: 88.3639, type: 'end' }
                    ];

                    landmarks.forEach(l => {
                        L.circleMarker([l.lat, l.lng], {
                            color: l.type === 'start' ? '#16a34a' : (l.type === 'end' ? '#2563eb' : '#94a3b8'),
                            fillColor: l.type === 'start' ? '#bbf7d0' : (l.type === 'end' ? '#bfdbfe' : '#e2e8f0'),
                            fillOpacity: 0.9,
                            radius: 6,
                            weight: 2
                        }).addTo(this.map).bindTooltip(l.name, { permanent: true, direction: 'top', offset: [0, -5], className: 'text-xs font-bold' });
                    });

                    // Planned Route Line
                    const routePoints = [
                        [22.8046, 86.2029],
                        [22.3460, 87.2320],
                        [22.4327, 87.8672],
                        [22.5726, 88.3639]
                    ];
                    L.polyline(routePoints, { color: '#64748b', dashArray: '5, 10', weight: 2 }).addTo(this.map);

                    // Simulated Deviation Path (Red) - Visualizing SOP-075
                    const deviationPoints = [
                        [22.3460, 87.2320], // Deviation Start
                        [22.3000, 87.3000]  // Detected Location
                    ];
                    L.polyline(deviationPoints, { color: '#ef4444', weight: 3, dashArray: '5, 5' })
                        .addTo(this.map)
                        .bindTooltip("Detected Deviation (SOP-075)", { direction: 'right', className: 'text-red-600 font-bold text-xs' });
                },
                updateMap() {
                    if (!this.currentTelemetry || !this.map) return;
                    
                    const lat = this.currentTelemetry.location.latitude;
                    const lng = this.currentTelemetry.location.longitude;
                    
                    const hasAlert = this.alerts && this.alerts.some(a => a.status !== 'RESOLVED');

                    if (!this.marker) {
                        this.marker = L.marker([lat, lng], { icon: this.vehicleIcon }).addTo(this.map);
                        this.lastMarkerLatLng = L.latLng(lat, lng);
                    } else {
                        this.animateMarkerTo(L.latLng(lat, lng));
                    }

                    // Rich Popup Content
                    const popupContent = `
                        <div class="min-w-[160px] font-sans">
                            <div class="font-bold text-slate-800 mb-2 border-b border-slate-200 pb-1 flex justify-between items-center">
                                <span>${this.selectedTruck}</span>
                                <span class="text-[10px] bg-slate-100 px-1 rounded">Live</span>
                            </div>
                            <div class="space-y-1 text-xs text-slate-600">
                                <div class="flex justify-between items-center"><span>Speed:</span> <span class="font-mono font-bold text-slate-800">${this.currentTelemetry.speed_kmh.toFixed(1)} km/h</span></div>
                                <div class="flex justify-between items-center"><span>Weight:</span> <span class="font-mono font-bold text-slate-800">${this.currentTelemetry.weight_kg.toFixed(0)} kg</span></div>
                            </div>
                            <div class="mt-3 pt-2 border-t border-slate-200 text-xs font-bold text-center">
                                ${hasAlert 
                                    ? '<span class="text-red-600 flex items-center justify-center"><i class="ph-warning mr-1"></i> UNDER ALERT</span>' 
                                    : '<span class="text-green-600 flex items-center justify-center"><i class="ph-check-circle mr-1"></i> NORMAL STATUS</span>'}
                            </div>
                        </div>
                    `;

                    this.marker.bindPopup(popupContent).openPopup();
                    
                    // Center map on truck but maintain view of route
                    // Only re-center if this is the first update or if we drift too far (optional)
                    // For demo, keep it centered
                    this.map.setView([lat, lng], 10);
                },
                updateMapForTruck(truckId, telemetry) {
                    if (!telemetry || !this.map) return;
                    const lat = telemetry.location.latitude;
                    const lng = telemetry.location.longitude;
                    if (!this.markersByTruck[truckId]) {
                        const m = L.marker([lat, lng], { icon: this.vehicleIcon }).addTo(this.map);
                        this.markersByTruck[truckId] = { marker: m, lastLatLng: L.latLng(lat, lng) };
                        m.bindTooltip(truckId, { direction: 'top' });
                    } else {
                        const entry = this.markersByTruck[truckId];
                        this.animateMarkerFor(entry, L.latLng(lat, lng));
                    }
                },
                animateMarkerFor(entry, targetLatLng) {
                    const startLatLng = entry.lastLatLng;
                    const duration = 1200;
                    const startTime = performance.now();
                    const animate = (now) => {
                        const t = Math.min((now - startTime) / duration, 1);
                        const lat = startLatLng.lat + (targetLatLng.lat - startLatLng.lat) * t;
                        const lng = startLatLng.lng + (targetLatLng.lng - startLatLng.lng) * t;
                        entry.marker.setLatLng([lat, lng]);
                        if (t < 1) requestAnimationFrame(animate);
                        else entry.lastLatLng = targetLatLng;
                    };
                    requestAnimationFrame(animate);
                },
                animateMarkerTo(targetLatLng) {
                    if (!this.marker) return;
                    const startLatLng = this.marker.getLatLng();
                    const duration = 1500;
                    const startTime = performance.now();
                    const animate = (now) => {
                        const t = Math.min((now - startTime) / duration, 1);
                        const lat = startLatLng.lat + (targetLatLng.lat - startLatLng.lat) * t;
                        const lng = startLatLng.lng + (targetLatLng.lng - startLatLng.lng) * t;
                        this.marker.setLatLng([lat, lng]);
                        if (t < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            this.lastMarkerLatLng = targetLatLng;
                        }
                    };
                    requestAnimationFrame(animate);
                },
                startPolling() {
                    this.polling = setInterval(() => {
                        this.fetchTrucks();
                        this.fetchSummary();
                        this.fetchAllStatuses();
                    }, 2000);
                }
            },
            mounted() {
                this.initMap();
                this.fetchTrucks();
                this.fetchSummary();
                this.startPolling();
                this.startIntelLog();
            }
        }).mount('#app')
    </script>
</body>
</html>
